<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <title>관리자 페이지</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container.table-list {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            width: 100%;
            margin-top: 50px;
        }

        .table-list {
            width: 100%;
            margin-top: 50px;
            margin-left: auto;
            margin-right: auto;
        }
        .member-container, .lesson-container {
            border: 3px solid #cccccc;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            width: 48%;
            background-color: white;
            box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.1);
        }
        .member-container h3, .lesson-container h3 {
            text-align: center;
            width: 100%;
        }
        .table-container{
            width: 100%;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #ccc;
        }
        .table thead th {
            position: sticky;
            z-index: 1;
            top: 0;
            vertical-align: middle;
            text-align: center;
        }
        .table tbody td {
            vertical-align: middle;
            text-align: center;
        }
        .table th, .table td {
            word-wrap: break-word;
        }
        #memberTable th:nth-child(1), .table td:nth-child(1) { width: 60px; }
        #memberTable th:nth-child(2), .table td:nth-child(2) { width: 100px; }
        #memberTable th:nth-child(3), .table td:nth-child(3) { width: 200px; }
        #memberTable th:nth-child(4), .table td:nth-child(4) { width: 100px; }
        #lessonTable th:nth-child(1), .table td:nth-child(1) { width: 60px; }
        #lessonTable th:nth-child(2), .table td:nth-child(2) { width: 200px; }
        #lessonTable th:nth-child(3), .table td:nth-child(3) { width: 100px; }

        .search-container {
            width: 100%;
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        #memberSearchInput, #lessonSearchInput {
            width: 250px;
        }
        #deleteMemberButton, #deleteLessonButton {
            width: 100px;
            margin-top: 15px;
            align-self: flex-end;
        }


    </style>
</head>
<body>
<div class="container table-list">

    <div class="member-container">
        <h3>회원 목록</h3>
        <div class="search-container">
            <input type="text" id="memberSearchInput" name="memberKeyword" class="form-control" placeholder="이름 또는 이메일 검색...">
            <button id="memberSearchButton" class="btn btn-primary ml-2">검색</button>
        </div>
        <div class="table-container">
            <table id="memberTable" class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                <tr>
                    <th>선택</th>
                    <th>이름</th>
                    <th>이메일</th>
                    <th>상태</th>
                </tr>
                </thead>
                <tbody id="memberTableBody">
                <tr th:each="member : ${members}">
                    <td><input type="checkbox" class="memberCheckbox" th:value="${member.id}"></td>
                    <td th:text="${member.name}"></td>
                    <td th:text="${member.email}"></td>
                    <td th:text="${member.status}"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <button class="btn btn-danger" id="deleteMemberButton">회원 삭제</button>
    </div>

    <div class="lesson-container">
        <h3>강의 관리</h3>
        <div class="search-container">
            <input type="text" id="lessonSearchInput" name="lessonKeyword" class="form-control" placeholder="강의명 검색...">
            <button id="lessonSearchButton" class="btn btn-primary ml-2">검색</button>
        </div>
        <div class="table-container">
            <table id="lessonTable" class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                <tr>
                    <th>선택</th>
                    <th>강의명</th>
                    <th>강사</th>
                </tr>
                </thead>
                <tbody id="lessonTableBody">
                <tr th:each="lesson : ${lessons}">
                    <td><input type="checkbox" class="lessonCheckbox" th:value="${lesson.id}"></td>
                    <td th:text="${lesson.title}"></td>
                    <td th:text="${lesson.masterName}"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <button class="btn btn-danger" id="deleteLessonButton">강의 삭제</button>
    </div>
</div>

<script>
    $(document).ready(function () {
        function searchMembers() {
            let memberKeyword = $("#memberSearchInput").val().trim();

            $.ajax({
                url: "/api/admin/member/search",
                type: "GET",
                data: { memberKeyword: memberKeyword },
                success: function (response) {
                    if (response.status !== 200) {
                        alert("검색에 실패했습니다.");
                        return;
                    }

                    let members = response.data;
                    let tableBody = $("#memberTableBody");
                    tableBody.empty();

                    if (members.length === 0) {
                        tableBody.append("<tr><td colspan='4' class='text-center'>검색 결과가 없습니다.</td></tr>");
                        return;
                    }

                    members.forEach(member => {
                        let row = `
                            <tr>
                                <td><input type="checkbox" class="memberCheckbox" value="${member.id}"></td>
                                <td>${member.name}</td>
                                <td>${member.email}</td>
                                <td>${member.status}</td>
                            </tr>`;
                        tableBody.append(row);
                    });
                },
                error: function () {
                    alert("검색 중 오류가 발생했습니다.");
                }
            });
        }

        function searchLessons() {
            let lessonKeyword = $("#lessonSearchInput").val().trim();

            $.ajax({
                url: "/api/admin/lesson/search",
                type: "GET",
                data: { lessonKeyword: lessonKeyword },
                success: function (response) {
                    if (response.status !== 200) {
                        alert("검색에 실패했습니다.")
                    }

                    let lessons = response.data;
                    let tableBody = $("#lessonTableBody");
                    tableBody.empty();

                    if (lessons.length === 0) {
                        tableBody.append("<tr><td colspan='3' class='text-center'>검색 결과가 없습니다.</td></tr>")
                        return;
                    }

                    lessons.forEach(lesson => {
                        let row = `
                            <tr>
                                <td><input type="checkbox" class="lessonCheckbox" value="${lesson.id}"></td>
                                <td>${lesson.title}</td>
                                <td>${lesson.masterName}</td>
                            </tr>`;
                        tableBody.append(row);
                    });
                },
                error: function () {
                    alert("검색 중 오류가 발생했습니다.")
                }
            });
        }

        $("#memberSearchButton").click(function () {
            searchMembers();
        });
        $("#memberSearchInput").keypress(function (event) {
            if (event.which === 13) {
                searchMembers();
            }
        });

        $("#lessonSearchButton").click(function () {
            searchLessons();
        });
        $("#lessonSearchInput").keypress(function (event) {
            if (event.which === 13) {
                searchLessons();
            }
        })

    });

    $("#deleteMemberButton").click(function () {
        let selectMembers = [];
        $(".memberCheckbox:checked").each(function () {
            selectMembers.push(Number($(this).val()));
        });

        console.log(selectMembers);

        if (selectMembers.length === 0) {
            alert("삭제할 회원을 선택해 주세요!")
            return;
        }

        $.ajax({
            url: "/api/admin/member/inactive",
            type: "POST",
            data: JSON.stringify(selectMembers),
            contentType: "application/json",
            success: function (response) {
                if (response.status === 200) {
                    alert("회원 상태를 비활성화 했습니다.");
                    location.reload();
                }else {
                    alert("회원 비활성화에 실패했습니다.");
                }
            },
            error: function () {
                alert("비활성화 중 오류가 발생했습니다.");
            }
        });
    });
</script>
</body>
</html>
