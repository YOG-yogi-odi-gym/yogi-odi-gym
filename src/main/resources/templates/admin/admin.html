<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>test</title>

    <meta charset="utf-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

    <link rel="stylesheet" th:href="@{css/admin.css}">
</head>
<body>
<div th:replace="admin/navbar.html"></div>
<div class="container-fluid d-flex flex-row table-list">
    <div class="member-container">
        <h3>회원 목록</h3>
        <div class="search-container">
            <input type="text" id="memberSearchInput" name="memberKeyword" class="form-control" placeholder="이름 또는 이메일 검색...">
            <button id="memberSearchButton" class="btn btn-primary ml-2">검색</button>
        </div>
        <div class="memberTable-container">
            <table id="memberTable" class="table table-bordered table-hover">
                <thead class="thead-dark">
                <tr>
                    <th></th>
                    <th>이름</th>
                    <th>이메일</th>
                    <th>상태</th>
                </tr>
                </thead>
                <tbody id="memberTableBody">
                <tr th:each="member : ${members}">
                    <td><input type="checkbox" class="memberCheckbox" th:value="${member.id}"></td>
                    <td th:text="${member.name}"></td>
                    <td th:text="${member.email}"></td>
                    <td th:text="${member.status}"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <button class="btn btn-danger" id="deleteMemberButton">삭제</button>
    </div>

    <div class="lesson-container">
        <h3>강의 관리</h3>
        <div class="search-container">
            <input type="text" id="lessonSearchInput" name="lessonKeyword" class="form-control" placeholder="강의명 검색...">
            <button id="lessonSearchButton" class="btn btn-primary ml-2">검색</button>
        </div>
        <div class="lessonTable-container">
            <table id="lessonTable" class="table table-bordered table-hover">
                <thead class="thead-dark">
                <tr>
                    <th></th>
                    <th>강의명</th>
                    <th>강사</th>
                </tr>
                </thead>
                <tbody id="lessonTableBody">
                <tr th:each="lesson : ${lessons}">
                    <td><input type="checkbox" class="lessonCheckbox" th:value="${lesson.id}"></td>
                    <td th:text="${lesson.title}"></td>
                    <td th:text="${lesson.masterName}"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <button class="btn btn-danger" id="deleteLessonButton">삭제</button>
    </div>

    <div class="board-container">
        <h3>게시글 관리</h3>
        <div class="search-container">
            <input type="text" id="boardSearchInput" name="boardKeyword" class="form-control" placeholder="게시글 검색...">
            <button id="boardSearchButton" class="btn btn-primary ml-2">검색</button>
        </div>
        <div class="boardTable-container">
            <table id="boardTable" class="table table-bordered table-hover">
                <thead class="thead-dark">
                <tr>
                    <th></th>
                    <th>제목</th>
                    <th>작성자</th>
                </tr>
                </thead>
                <tbody id="boardTableBody">
                <tr th:each="board : ${boards}">
                    <td><input type="checkbox" class="boardCheckbox" th:value="${board.id}"></td>
                    <td th:text="${board.title}"></td>
                    <td th:text="${board.memberName}"></td>
                </tr>
                </tbody>
            </table>
        </div>
        <button class="btn btn-danger" id="deleteBoardButton">삭제</button>
    </div>

    <div class="apply-category-container">
        <div class="apply-container">
            <h3>강사 신청</h3>
            <div class="search-container">
                <input type="text" id="applySearchInput" name="applyKeyword" class="form-control" placeholder="신청자 검색...">
                <button id="applySearchButton" class="btn btn-primary ml-2">검색</button>
            </div>
            <div class="applyTable-container">
                <table id="applyTable" class="table table-bordered table-hover">
                    <thead class="thead-dark">
                    <tr>
                        <th></th>
                        <th>강의명</th>
                        <th>강사</th>
                    </tr>
                    </thead>
                    <tbody id="applyTableBody">
                    <tr>
                    </tr>
                    </tbody>
                </table>
            </div>
            <button class="btn btn-danger" id="deleteApplyButton">신청 삭제</button>
        </div>

        <div class="category-container">
            <h3>카테고리 관리</h3>
            <div class="categoryTable-container">
                <div class="table-wrap">
                    <table id="categoryTable-les" class="table table-bordered table-hover">
                        <thead class="thead-dark">
                        <tr>
                            <th></th>
                            <th>강의</th>
                        </tr>
                        </thead>
                        <tbody id="categoryTableBody-les">
                        <tr th:each="category : ${categories}" th:if="${category.code == 'lesson'}">
                            <td><input type="checkbox" class="boardCheckbox" th:value="${category.id}"></td>
                            <td th:text="${category.name}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="table-wrap">
                    <table id="categoryTable-board" class="table table-bordered table-hover">
                        <thead class="thead-dark">
                        <tr>
                            <th></th>
                            <th>게시판</th>
                        </tr>
                        </thead>
                        <tbody id="categoryTableBody-board">
                        <tr th:each="category : ${categories}" th:if="${category.code == 'board'}">
                            <td><input type="checkbox" class="boardCheckbox" th:value="${category.id}"></td>
                            <td th:text="${category.name}"></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="category-btnGroup">
                <button class="btn btn-success" id="insertCategoryButton">추가</button>
                <button class="btn btn-success" id="updateCategoryButton">수정</button>
                <button class="btn btn-danger" id="deleteCategoryButton">삭제</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {

        const csrfToken = $('meta[name="_csrf"]').attr('content');
        const csrfHeader = $("meta[name='_csrf_header']").attr("content");

        function searchMembers() {
            let memberKeyword = $("#memberSearchInput").val().trim();

            $.ajax({
                url: "/api/admin/member/search",
                type: "GET",
                data: { memberKeyword: memberKeyword },
                success: function (response) {
                    if (response.status !== 200) {
                        alert("검색에 실패했습니다.");
                        return;
                    }

                    let members = response.data;
                    let tableBody = $("#memberTableBody");
                    tableBody.empty();

                    if (members.length === 0) {
                        tableBody.append("<tr><td colspan='4' class='text-center'>검색 결과가 없습니다.</td></tr>");
                        return;
                    }

                    members.forEach(member => {
                        let row = `
                            <tr>
                                <td><input type="checkbox" class="memberCheckbox" value="${member.id}"></td>
                                <td>${member.name}</td>
                                <td>${member.email}</td>
                                <td>${member.status}</td>
                            </tr>`;
                        tableBody.append(row);
                    });
                },
                error: function () {
                    alert("검색 중 오류가 발생했습니다.");
                }
            });
        }

        function searchLessons() {
            let lessonKeyword = $("#lessonSearchInput").val().trim();

            $.ajax({
                url: "/api/admin/lesson/search",
                type: "GET",
                data: { lessonKeyword: lessonKeyword },
                success: function (response) {
                    if (response.status !== 200) {
                        alert("검색에 실패했습니다.")
                    }

                    let lessons = response.data;
                    let tableBody = $("#lessonTableBody");
                    tableBody.empty();

                    if (lessons.length === 0) {
                        tableBody.append("<tr><td colspan='3' class='text-center'>검색 결과가 없습니다.</td></tr>")
                        return;
                    }

                    lessons.forEach(lesson => {
                        let row = `
                            <tr>
                                <td><input type="checkbox" class="lessonCheckbox" value="${lesson.id}"></td>
                                <td>${lesson.title}</td>
                                <td>${lesson.masterName}</td>
                            </tr>`;
                        tableBody.append(row);
                    });
                },
                error: function () {
                    alert("검색 중 오류가 발생했습니다.")
                }
            });
        }

        function searchBoards() {
            let boardKeyword = $("#boardSearchInput").val().trim();

            $.ajax({
                url: "/api/admin/board/search",
                type: "GET",
                data: { boardKeyword: boardKeyword },
                success: function (response) {
                    if (response.status !== 200) {
                        alert("검색에 실패했습니다.")
                    }

                    let boards = response.data;
                    let tableBody = $("#boardTableBody");
                    tableBody.empty();

                    if (boards.length === 0) {
                        tableBody.append("<tr><td colspan='3' class='text-center'>검색 결과가 없습니다.</td></tr>")
                        return;
                    }

                    boards.forEach(board => {
                        let row = `
                            <tr>
                                <td><input type="checkbox" class="boardCheckbox" value="${board.id}"></td>
                                <td>${board.title}</td>
                                <td>${board.memberName}</td>
                            </tr>`;
                        tableBody.append(row);
                    });
                },
                error: function () {
                    alert("검색 중 오류가 발생했습니다.")
                }
            });
        }

        $("#memberSearchButton").click(function () {
            searchMembers();
        });
        $("#memberSearchInput").keypress(function (event) {
            if (event.which === 13) {
                searchMembers();
            }
        });

        $("#lessonSearchButton").click(function () {
            searchLessons();
        });
        $("#lessonSearchInput").keypress(function (event) {
            if (event.which === 13) {
                searchLessons();
            }
        })

        $("#boardSearchButton").click(function () {
            searchBoards();
        });
        $("#boardSearchInput").keypress(function (event) {
            if (event.which === 13) {
                searchBoards();
            }
        })

        $("#deleteMemberButton").click(function () {

            let selectMembers = [];

            $(".memberCheckbox:checked").each(function () {
                selectMembers.push(Number($(this).val()));
            });

            console.log(selectMembers);

            if (selectMembers.length === 0) {
                alert("삭제할 회원을 선택해 주세요!")
                return;
            }

            $.ajax({
                url: "/api/admin/member/inactive",
                type: "POST",
                data: JSON.stringify(selectMembers),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function (response) {
                    if (response.status === 200) {
                        alert("회원 상태를 비활성화 했습니다.");
                        location.reload();
                    }else {
                        alert("회원 비활성화에 실패했습니다.");

                        console.log(response.status);
                        console.log(response.data);
                    }
                },
                error: function (xhr) {
                    console.log(xhr.responseText);
                    alert("비활성화 중 오류가 발생했습니다.");
                }
            });
        });

        $("#deleteLessonButton").click(function () {
            let selectLessons = [];

            $(".lessonCheckbox:checked").each(function() {
                selectLessons.push(Number($(this).val()));
            });

            if (selectLessons.length === 0) {
                alert("삭제할 강의를 선택해 주세요!");
                return;
            }

            $.ajax({
                url: "/api/admin/lesson/delete",
                type: "POST",
                data: JSON.stringify(selectLessons),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function (response) {
                    if (response.status === 200) {
                        alert("강의를 삭제했습니다.")
                        location.reload();
                    } else {
                        alert("강의 삭제에 실패했습니다.");
                        console.log(response.status);
                        console.log(response.data);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error : ", status, error);
                    console.error("Response : ", xhr.responseText);
                    alert("삭제중 오류가 발생하였습니다.");
                }
            });
        });

        $("#deleteBoardButton").click(function () {
            let selectBoards = [];

            $(".boardCheckbox:checked").each(function() {
                selectBoards.push(Number($(this).val()));
            });

            if (selectBoards.length === 0) {
                alert("삭제할 게시글을 선택해 주세요!");
                return;
            }

            $.ajax({
                url: "/api/admin/board/delete",
                type: "POST",
                data: JSON.stringify(selectBoards),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function (response) {
                    if (response.status === 200) {
                        alert("게시글을 삭제했습니다.")
                        location.reload();
                    } else {
                        alert("게시글 삭제에 실패했습니다.");
                        console.log(response.status);
                        console.log(response.data);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error : ", status, error);
                    console.error("Response : ", xhr.responseText);
                    alert("삭제중 오류가 발생하였습니다.");
                }
            });
        });

        $("#deleteCategoryButton").click(function () {
            let selectCategories = [];

            $(".boardCheckbox:checked").each(function() {
                selectCategories.push(Number($(this).val()));
            });

            console.log(selectCategories);

            if (selectCategories.length === 0) {
                alert("삭제할 카테고리를 선택해 주세요!");
                return;
            }

            $.ajax({
                url: "/api/admin/category/delete",
                type: "POST",
                data: JSON.stringify(selectCategories),
                contentType: 'application/json; charset=utf-8',
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(csrfHeader, csrfToken);
                },
                success: function (response) {
                    if (response.status === 200) {
                        alert("카테고리를 삭제했습니다.")
                        location.reload();
                    } else {
                        alert("카테고리 삭제에 실패했습니다.");
                        console.log(response.status);
                        console.log(response.data);
                    }
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error : ", status, error);
                    console.error("Response : ", xhr.responseText);
                    alert("삭제중 오류가 발생하였습니다.");
                }
            });
        });
    });
</script>
</body>
</html>